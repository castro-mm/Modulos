<div class="container-fluid">
    <app-breadcrumb/>
    <p-panel header="Filtros de Pesquisa" [toggleable]="true" [collapsed]="true" class="mb-4">
        <form [formGroup]="form" (submit)="listar()" #f>
            <p-divider class="mt-1" />
            <div class="row mt-2">            
                <div class="col-2">
                    <label for="segmentoDoCredorId" class="mb-1">Segmento do Credor:</label>
                    <p-select 
                        formControlName="segmentoDoCredorId" 
                        inputId="segmentoDoCredor" 
                        [options]="segmentoDoCredorOptions"
                        optionLabel="label" 
                        optionValue="value" 
                        appendTo="body"
                        placeholder="Selecione..."
                        fluid 
                        />
                </div>
            </div>
            <div class="row mt-2">            
                <div class="col-4">
                    <label for="nomeFantasia" class="mb-1">Nome Fantasia:</label>
                    <input 
                        id="nomeFantasia" 
                        formControlName="nomeFantasia" 
                        pInputText 
                        fluid />
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-4">
                    <label for="razaoSocial" class="mb-1">Razão Social:</label>
                    <input 
                        id="razaoSocial" 
                        formControlName="razaoSocial" 
                        pInputText 
                        fluid />
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-2">
                    <label for="cnpj" class="mb-1">CNPJ:</label>
                    <input 
                        id="cnpj" 
                        formControlName="cnpj" 
                        pInputText 
                        mask="00.000.000/0000-00" 
                        [showMaskTyped]="true" 
                        [dropSpecialCharacters]="true"
                        [validation]="true"
                        fluid />
                        @if (form.get('cnpj')?.errors?.['invalidCnpj']) {
                            <p-message severity="error" size="small" variant="simple">O CNPJ deve seguir o formato válido.</p-message>
                        }    
                </div>
            </div>
            <p-divider class="mt-3" />
            <div class="row mt-3">
                <div class="col-12 text-end mt-1">
                    <p-button icon="pi pi-times" label="Limpar" severity="secondary" class="me-2" text (click)="f.reset()"/>
                    <p-button icon="pi pi-search" [loading]="isLoading" [label]="isLoading ? 'Executando...': 'Pesquisar'" severity="success" type="submit"/>
                </div>
            </div>
        </form>        
    </p-panel>    
    <p-table        
        #dt
        [value]="entityList()"
        [rows]="10"
        [paginator]="true"
        [globalFilterFields]="['nomeFantasia', 'razaoSocial', 'cnpj']"
        [(selection)]="itensSelecionados"
        [rowHover]="true"
        dataKey="id"
        currentPageReportTemplate="{first} até {last} de {totalRecords} registros"
        [showCurrentPageReport]="true"
        [rowsPerPageOptions]="[10, 20, 30]"
        size="small"
        [loading]="isLoading"
        [loadingIcon]="'pi pi-spinner pi-spin'"
    >
        <ng-template #caption>
            <div class="flex items-center justify-between">
                <div class="m-0">
                    <p-button pTooltip="Novo registro" icon="pi pi-plus" (click)="openDialog()" class="mr-2"></p-button>
                    <p-button pTooltip="Excluir itens selcionados" severity="danger" icon="pi pi-trash" (click)="excluirVarios()" [disabled]="!itensSelecionados || !itensSelecionados.length" />        
                </div>
                <p-iconfield>
                    <p-inputicon class="pi pi-search" />
                    <input pInputText type="text" (input)="onGlobalFilter(dt, $event)" placeholder="Pesquisar..." />
                </p-iconfield>  
            </div>
        </ng-template>
        <ng-template #header >
            <tr>
                <th style="width: 3rem; background-color: #f8f9fa">
                    <p-tableHeaderCheckbox />
                </th>
                <th style="min-width: 2rem; background-color: #f8f9fa">Código</th>
                <th pSortableColumn="nomeFantasia" style="min-width:16rem; background-color: #f8f9fa">
                    Nome Fantasia
                    <p-sortIcon field="nomeFantasia" />
                </th>
                <th pSortableColumn="razaoSocial" style="min-width:16rem; background-color: #f8f9fa">
                    Razão Social
                    <p-sortIcon field="razaoSocial" />
                </th>
                <th pSortableColumn="cnpj" style="min-width:14rem; background-color: #f8f9fa">
                    CNPJ
                    <p-sortIcon field="cnpj" />
                </th>
                <th pSortableColumn="segmentoDoCredor" style="min-width:14rem; background-color: #f8f9fa">
                    Segmento do Credor
                    <p-sortIcon field="segmentoDoCredor" />
                </th>
                <th pSortableColumn="dataDeCriacao" style="min-width: 8rem; background-color: #f8f9fa">
                    Data de Criação
                    <p-sortIcon field="dataDeCriacao" />
                </th>
                <th pSortableColumn="dataDeAtualizacao" style="min-width:10rem; background-color: #f8f9fa">
                    Data de Atualização
                    <p-sortIcon field="dataDeAtualizacao" />
                </th>
                <th style="min-width: 3rem; background-color: #f8f9fa"></th>
            </tr>
        </ng-template>
        <ng-template #body let-item>
            <tr>
                <td style="width: 3rem">
                    <p-tableCheckbox [value]="item" />
                </td>
                <td style="min-width: 2rem">{{ item.id }}</td>
                <td style="min-width: 16rem">{{ item.nomeFantasia }}</td>
                <td style="min-width: 16rem">{{ item.razaoSocial }}</td>
                <td style="min-width: 14rem">{{ item.cnpj | cnpj }}</td>
                <td style="min-width: 14rem">{{ item.segmentoDoCredor.nome }}</td>
                <td style="min-width: 8rem">{{ item.dataDeCriacao | date: 'dd/MM/yyyy HH:mm:ss' }}</td>
                <td style="min-width: 10rem">{{ item.dataDeAtualizacao | date:'dd/MM/yyyy HH:mm:ss' }}</td>
                <td>    
                    <p-button icon="pi pi-pencil" class="mr-2" variant="text" (click)="openDialog(item)" pTooltip="Editar" />
                    <p-button icon="pi pi-trash" severity="danger" variant="text" (click)="excluir(item)" pTooltip="Excluir" />
                </td>
            </tr>
        </ng-template>
    </p-table>
</div>