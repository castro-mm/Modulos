<div class="container-fluid">
    <app-breadcrumb/>
    <p-panel header="Filtros de Pesquisa" [toggleable]="true" [collapsed]="true" class="mb-4">
        <form [formGroup]="form" (submit)="listar()" #f>
            <p-divider class="mt-1" />
            <div class="row mt-2">
                <div class="col-4">
                    <label for="nome" class="mb-1">Nome:</label>
                    <input 
                        id="nome" 
                        formControlName="nome" 
                        pInputText 
                        fluid />
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-2">
                    <label for="cpf" class="mb-1">CPF:</label>
                    <input 
                        id="cpf" 
                        formControlName="cpf" 
                        pInputText 
                        mask="000.000.000-00" 
                        [showMaskTyped]="true" 
                        [dropSpecialCharacters]="true"
                        [validation]="true"
                        fluid />
                        @if (form.get('cpf')?.errors?.['invalidCpf']) {
                            <p-message severity="error" size="small" variant="simple">O CPF deve seguir o formato válido.</p-message>
                        }    
                </div>
            </div>
            <p-divider class="mt-3" />
            <div class="row mt-3">
                <div class="col-12 text-end mt-1">
                    <p-button 
                        icon="pi pi-times" 
                        label="Limpar" 
                        severity="secondary" 
                        class="me-2" 
                        text 
                        (click)="f.reset()"/>
                    <p-button 
                        icon="pi pi-search" 
                        [loading]="isLoading" 
                        [label]="isLoading ? 'Executando...': 'Pesquisar'" 
                        severity="success" 
                        type="submit"
                        [disabled]="form.invalid || isLoading"
                        />
                </div>
            </div>
        </form>        
    </p-panel>    
    <p-table        
        #dt
        [value]="entityList()"
        [rows]="10"
        [paginator]="true"
        [globalFilterFields]="['nome', 'cpf']"
        [(selection)]="itensSelecionados"
        [rowHover]="true"
        dataKey="id"
        currentPageReportTemplate="{first} até {last} de {totalRecords} registros"
        [showCurrentPageReport]="true"
        [rowsPerPageOptions]="[10, 20, 30]"
        size="small"
        [loading]="isLoading"
        [loadingIcon]="'pi pi-spinner pi-spin'"
    >
        <ng-template #caption>
            <div class="flex items-center justify-between">
                <div class="m-0">
                    <p-button pTooltip="Novo registro" icon="pi pi-plus" (click)="openDialog()" class="mr-2"></p-button>
                    <p-button pTooltip="Excluir itens selcionados" severity="danger" icon="pi pi-trash" (click)="excluirVarios()" [disabled]="!itensSelecionados || !itensSelecionados.length" />        
                </div>
                <p-iconfield>
                    <p-inputicon class="pi pi-search" />
                    <input pInputText type="text" (input)="onGlobalFilter(dt, $event)" placeholder="Pesquisar..." />
                </p-iconfield>  
            </div>
        </ng-template>
        <ng-template #header >
            <tr>
                <th style="width: 3rem; background-color: #f8f9fa">
                    <p-tableHeaderCheckbox />
                </th>
                <th style="min-width: 2rem; background-color: #f8f9fa">Código</th>
                <th pSortableColumn="nome" style="min-width:16rem; background-color: #f8f9fa">
                    Nome
                    <p-sortIcon field="nome" />
                </th>
                <th pSortableColumn="email" style="min-width:16rem; background-color: #f8f9fa">
                    Email
                    <p-sortIcon field="email" />
                </th>
                <th pSortableColumn="cpf" style="min-width:14rem; background-color: #f8f9fa">
                    CPF
                    <p-sortIcon field="cpf" />
                </th>
                <th pSortableColumn="dataDeCriacao" style="min-width: 8rem; background-color: #f8f9fa">
                    Data de Criação
                    <p-sortIcon field="dataDeCriacao" />
                </th>
                <th pSortableColumn="dataDeAtualizacao" style="min-width:10rem; background-color: #f8f9fa">
                    Data de Atualização
                    <p-sortIcon field="dataDeAtualizacao" />
                </th>
                <th style="min-width: 3rem; background-color: #f8f9fa"></th>
            </tr>
        </ng-template>
        <ng-template #body let-item>
            <tr>
                <td style="width: 3rem">
                    <p-tableCheckbox [value]="item" />
                </td>
                <td style="min-width: 2rem">{{ item.id }}</td>
                <td style="min-width: 16rem">{{ item.nome }}</td>
                <td style="min-width: 16rem">{{ item.email }}</td>
                <td style="min-width: 14rem">{{ item.cpf | cpf }}</td>
                <td style="min-width: 8rem">{{ item.dataDeCriacao | date: 'dd/MM/yyyy HH:mm:ss' }}</td>
                <td style="min-width: 10rem">{{ item.dataDeAtualizacao | date:'dd/MM/yyyy HH:mm:ss' }}</td>
                <td>    
                    <p-button icon="pi pi-pencil" class="mr-2" variant="text" (click)="openDialog(item)" pTooltip="Editar" />
                    <p-button icon="pi pi-trash" severity="danger" variant="text" (click)="excluir(item)" pTooltip="Excluir" />
                </td>
            </tr>
        </ng-template>
    </p-table>
</div>