<div class="container-fluid">
    <app-breadcrumb/>
    <!-- Cards de Resumo Principal -->
    <div class="row g-3 mb-4">
        <!-- Contas Abertas -->
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="text-muted mb-1 fw-bold">Contas Abertas</p>
                            <h3 class="mb-0 fw-bold">{{ quantitativoDeContas?.contasAbertas?.quantidade ?? 0 }}</h3>
                        </div>
                        <div class="bg-primary bg-opacity-10 rounded-circle p-3">
                            <i class="pi pi-file-edit text-primary" style="font-size: 1.5rem;"></i>
                        </div>
                    </div>
                    <div class="mt-3">
                        <p class="mb-1 small text-muted fw-bold">Valor Total</p>
                        <h5 class="text-primary mb-0">{{ quantitativoDeContas?.contasAbertas?.valor ?? 0 | currency:'BRL':'symbol':'1.2-2':'pt-BR' }}</h5>
                    </div>
                </div>
                <div class="card-footer bg-primary text-white text-center py-2">
                    <small>{{ quantitativoDeContas?.contasAbertas?.percentual ?? 0 | number:'1.2-2':'pt-BR' }}% do total</small>
                </div>
            </div>
        </div>

        <!-- Contas Vencidas -->
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="text-muted mb-1 fw-bold">Contas Vencidas</p>
                            <h3 class="mb-0 fw-bold">{{ quantitativoDeContas?.contasVencidas?.quantidade ?? 0 }}</h3>
                        </div>
                        <div class="bg-danger bg-opacity-10 rounded-circle p-3">
                            <i class="pi pi-exclamation-triangle text-danger" style="font-size: 1.5rem;"></i>
                        </div>
                    </div>
                    <div class="mt-3">
                        <p class="mb-1 small text-muted fw-bold">Valor Total</p>
                        <h5 class="text-danger mb-0">{{ quantitativoDeContas?.contasVencidas?.valor ?? 0 | currency:'BRL':'symbol':'1.2-2':'pt-BR' }}</h5>
                    </div>
                </div>
                <div class="card-footer bg-danger text-white text-center py-2">
                    <small>{{ quantitativoDeContas?.contasVencidas?.percentual ?? 0 | number:'1.2-2':'pt-BR' }}% do total</small>
                </div>
            </div>
        </div>

        <!-- Contas Pagas -->
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="text-muted mb-1 fw-bold">Contas Pagas</p>
                            <h3 class="mb-0 fw-bold">{{ quantitativoDeContas?.contasPagas?.quantidade ?? 0 }}</h3>
                        </div>
                        <div class="bg-success bg-opacity-10 rounded-circle p-3">
                            <i class="pi pi-check-circle text-success" style="font-size: 1.5rem;"></i>
                        </div>
                    </div>
                    <div class="mt-3">
                        <p class="mb-1 small text-muted fw-bold">Valor Total</p>
                        <h5 class="text-success mb-0">{{ quantitativoDeContas?.contasPagas?.valor ?? 0 | currency:'BRL':'symbol':'1.2-2':'pt-BR' }}</h5>
                    </div>
                </div>
                <div class="card-footer bg-success text-white text-center py-2">
                    <small>{{ quantitativoDeContas?.contasPagas?.percentual ?? 0 | number:'1.2-2':'pt-BR' }}% do total</small>
                </div>
            </div>
        </div>

        <!-- Contas que Vencem Hoje -->
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="text-muted mb-1 fw-bold">Vencem Hoje</p>
                            <h3 class="mb-0 fw-bold">{{ quantitativoDeContas?.contasQueVencemHoje?.quantidade ?? 0 }}</h3>
                        </div>
                        <div class="bg-warning bg-opacity-10 rounded-circle p-3">
                            <i class="pi pi-clock text-warning" style="font-size: 1.5rem;"></i>
                        </div>
                    </div>
                    <div class="mt-2">
                        <p class="small text-muted fw-bold">Valor Total</p>
                        <h5 class="text-warning mb-0">{{ quantitativoDeContas?.contasQueVencemHoje?.valor ?? 0 | currency:'BRL':'symbol':'1.2-2':'pt-BR' }}</h5>
                    </div>
                </div>
                <div class="card-footer bg-warning text-dark text-center py-2">
                    <small>{{ quantitativoDeContas?.contasQueVencemHoje?.percentual ?? 0 | number:'1.2-2':'pt-BR' }}% do total</small>
                </div>
            </div>
        </div>
    </div>

    <p-card header="Contas em Aberto" class="mb-4 shadow-sm">
        <p class="mt-3">
            <app-table-list
                [cols]="cols"
                [rows]="10"
                [entityList]="registros"
                [modalSize]="modalSize"
                [globalFilterFields]="filterFields"
                [isLoading]="isLoading()"
                [detailComponent]="detailComponent"
                (onListar)="getRegistrosDeContas()"
                (onExcluirVarios)="excluirVarios($event)"
                (onExcluir)="excluir($event)"
                [templates]="columnTemplates"
            />
    
            <!--Definição dos templates customizados nas colunas-->
            <ng-template #statusTemplate let-item>
                <span class="position-relative">
                    <p-tag 
                        [value]="item.status | statusDaConta" 
                        [severity]="getStatusSeverity(item.status)" 
                        [icon]="getStatusIcon(item.status)" 
                        [pTooltip]="item.status === 1 ? 'Pago em ' + formatDate(item.dataDePagamento) : ''"
                    />
                    @if(item.status !== 1) {
                        <p-badge 
                            severity="danger" 
                            class="position-absolute top-0 start-100 translate-middle" 
                            [value]="obterPrazoPorStatus(item, 1)" 
                            [pTooltip]="obterPrazoPorStatus(item, 2)" 
                        />                                
                    }
                </span>
            </ng-template>
            <ng-template #arquivoTemplate let-item>
                @if (item.arquivos.length > 0) {
                    @if(item.arquivos.length < 2) {
                        <p-button icon="pi pi-upload" severity="warn" class="mr-2" outlined (click)="openArquivoDialog(item.id)" pTooltip="Adicionar Arquivo" />
                    } 
                    @if(obterArquivo(item, 1)) {
                        <p-button icon="pi pi-dollar" severity="info" class="mr-2" outlined (click)="visualizarArquivo(obterArquivo(item, 1)!)" pTooltip="Visualizar Boleto" />
                    } 
                    @if(obterArquivo(item, 2)) { 
                        <p-button icon="pi pi-receipt" severity="help" class="mr-2" outlined (click)="visualizarArquivo(obterArquivo(item, 2)!)" pTooltip="Visualizar Comprovante" />
                    } 
                } @else {
                    <p-button icon="pi pi-upload" severity="warn" class="mr-2" outlined (click)="openArquivoDialog(item.id)" pTooltip="Adicionar Arquivo" />
                }    
            </ng-template>
        </p>
    </p-card>
</div>

<!-- Dialog para visualização de arquivos -->
<p-dialog 
    header="Visualizar Arquivo" 
    [visible]="exibirDialog" 
    [modal]="true" 
    [style]="{width: '90vw', height: '90vh'}" 
    [contentStyle]="{height: 'calc(100% - 60px)', overflow: 'hidden'}"
    [closable]="false"
    [maximizable]="true"
>
    @if (visualizacaoConfig?.isImagem) {
        <div style="width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; overflow: auto;">
            <img [src]="visualizacaoConfig?.urlArquivo" alt="Imagem do Arquivo" style="max-width: 100%; max-height: 100%; object-fit: contain;" />
        </div>    
    } @else {
        <div style="width: 100%; height: 100%;">
            <iframe [src]="visualizacaoConfig?.urlArquivo! | safeUrl: 'resourceUrl'" style="width: 100%; height: 100%; border: none;"></iframe>
        </div>
    }
    <ng-template pTemplate="footer">
        <div class="col-12" style="text-align: right;">
            <p-button label="Baixar" icon="pi pi-download" severity="success" (click)="baixarArquivo(visualizacaoConfig?.arquivoSelecionado)" class="mr-2" ></p-button>
            <p-button label="Excluir" icon="pi pi-trash" severity="danger" (click)="excluirArquivo(visualizacaoConfig?.arquivoSelecionado)" class="mr-2" ></p-button>    
            <p-button label="Fechar" icon="pi pi-times" severity="secondary" (click)="exibirDialog = false"></p-button>
        </div>
    </ng-template>
</p-dialog>
